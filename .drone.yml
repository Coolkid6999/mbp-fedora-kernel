---
kind: pipeline
name: mbp-fedora-kernel

steps:
- name: build
  image: fedora:30
  pull: always
  volumes:
    - name: build-artifacts
      path: /tmp/artifacts
  commands:
    - ls
    - |
      echo "CPU threads: $(nproc --all)"
    - cat /proc/cpuinfo | grep 'model name' | uniq
    - pwd
    - dnf install -y fedpkg fedora-packager rpmdevtools ncurses-devel pesign git libkcapi libkcapi-devel libkcapi-static libkcapi-tools
    - git clone https://src.fedoraproject.org/rpms/kernel.git
    - git clone https://github.com/aunali1/linux-mbp-arch
    - cd kernel
    - git checkout f30
    - dnf -y builddep kernel.spec
    - |
      sed -i "s/Patch526/Patch536/g" kernel.spec
    - |
      sed -i "s/Patch527/Patch537/g" kernel.spec
    - |
      for patch_file in $(ls ../linux-mbp-arch | grep patch | grep -v 000); do scripts/newpatch.sh ../linux-mbp-arch/$patch_file; done
    - fedpkg srpm
    - ./scripts/fast-build.sh x86_64 kernel-4.15.3-300.my_kernel.fc27.src.rpm
    - cp -rfv x86_64/*.rpm /tmp/artifacts/

- name: publish-github
  image: plugins/github-release
  volumes:
    - name: build-artifacts
      path: /tmp/artifacts
  settings:
    api_key:
      from_secret: github_token
    files: /tmp/artifacts/*
    prerelease: yes
  when:
    event: tag

volumes:
- name: build-artifacts
  temp: {}
